;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;; paul's parser for tom's own minimal language
;;;;
;;;; (C) 2013, 2014 Paul Nathan
;;;; License: LLGPL (http://opensource.franz.com/preamble.html)


;; Aim is to implement TOML v0.1
;;
;; https://github.com/mojombo/toml/blob/master/versions/toml-v0.1.0.md

(defpackage :pp-toml
  (:use
   :common-lisp
   :esrap)
  (:export
   #:parse-toml

   #:parse-string
   #:strip-comments

   :value
   :datetime
   :preamble
   :keyvalue
   :keygroup))

(in-package :pp-toml)

(defun not-doublequote (char)
  (not (eql #\" char)))

(defun not-bracket (char)
  (not (eql #\] char)))

(defun not-integer (string)
  (when (find-if-not #'digit-char-p string)
    t))

(defun not-special-case (char)
  (not (member char
               '(#\[
                 #\]
                 #\"
                 #\Space
                 #\Newline
                 #\tab
                 #\=
                 #\.))))

(defrule integer (or "0" "1" "2" "3" "4" "5" "6" "7" "8" "9"))

(defrule 4-integers (and integer integer integer integer))

(defrule 2-integers (and integer integer ) )

;;1979-05-27T07:32:00Z
(defrule datetime (and 4-integers #\- 2-integers #\- 2-integers #\T
                       2-integers #\: 2-integers #\: 2-integers #\Z)
  (:lambda (list)
    (list
     :datetime
     (local-time:parse-timestring
      (format nil "狺ㄡ戾犷潋獒烘灬趑孱扉篝┅┅┅ㄤ彐蝓戾麒轸弩疳沐ǐ矧＼箴徙＼翎＼铄黛轭濠ê泔铙翎铘瑚螬ㄤ彐蝓戾犰痂犷蹴弪殂ㄡ祓栳铛礤蜷沭汨狎徙翦颟ㄤ彐蝓戾篝蜷铉汨狎矧铒舡滹踱戾聃雉汨狎徙翦颟ㄡ钿＼＼З┅换隋珧秕痼狎腩秣狍翎忪弩轭霭伯ㄤ彐蝓戾脲珧秕瓠汨狎矧铒舡怛徙脲汨狎徙翦颟＼┅ㄤ彐蝓戾铒蝽犰脲ǐ铒舡箴邈獒飙汜箦汨狎徙翦颟ê翦扉篝┅ㄤ彐躅趄犷箪轸弪狒瀛躅殂镤篝蜷铉ㄣ飙痧泸搴蝈珏蝈痨徙瀛犰④苘荃ㄜ茕待篝蜷铉＇灬礅溽换深翦蜴徙屮疱泗邃怡蝈珏瓠蝈痨徙瀛犰翎蜱弭篝蜷铉篝狎孱磲翥璀篝狎磲翥璀孱蝈绛篝狎趔蝈绛孱潴ㄤ邈灬蝈ㄩ珙矧篝狎孱磲翥璀篝狎磲翥璀孱洎ㄦ矧磲峄狺Β蝈绛篝狎趔蝈绛孱潴戾è磲翥桢洵泔溴篚怏羼翎蜱弭篝蜷铉ㄡ蝈蝈绛篝狎趔癌ㄡ蝈蝈绛孱潴癌┅换泔铞弪翳汨狎轭麸篝蜷铉篝蜷铉换泔铞弪翳轭翦珏麸翳泔溴汨狎徙翦ㄣ镤瀛汨狎换泔铞弪翳篝蜷铉麸犷轭翦珏疳蝮瀛轭翦珏磲翥桢洵泔溴┅┅┅ㄤ彐躅趄犷箪轸弪狒瀛麸箴邈獒祗篝蜷铉ㄦ戾è趄翎蜱弭蝈痨箦翩篝蜷铉ㄣ飙痧泸搴蝈珏蝈痨徙瀛犰ㄣ飙痧泸搴聃雉瀛礤翎汨狎翎蜱弭篝蜷铉篝蜷铉蝈痨┅┅换犰痂箫螋邃趄④茆＼箩汶箴徙濠换谅锰滹弩铒轭沆蹁＼骑蝽－徕沆趄④苕＼骑蝽趄④茴＼涕铄驽邃趄④茯＼义趱蝾趄④荇＼葬猢换麸滹溴翦蝽轭麒翳轶轶泔眄孱翦秕换趄④苘＼趄④＼趄④苘堍＼堠┅ㄤ彐蝓戾篝蜷铉泔铘孱趔í矧ㄡ钿④堍④篝蜷铉汨狎┅ê灬礅溽螬ㄦ矧磲铋泾祜镳骘鲠轭泔祆邈ㄩ扉篝鲠颟＼鲠颟┅┅ㄤ彐蝓戾篝蜷铉ㄡ钿＼篝蜷铉泔铘孱趔＼ê溴篝蝓泗躜癖篝蜷铉癫ㄤ邈灬蝈ㄩ珙矧癖癫┅扉篝后趄轭趄犷箪轸弪狒瀛麸箴邈獒祗趄犷箪轸弪狒瀛躅殂镤翦篝蜷铉┅┅┅ㄤ彐蝓戾铛礅弪ㄡ钿ㄡ钿ǐ矧阿⒈⒉⒊⒋⒌⒍⒎⒏⒐┅ㄡ钿＼ǐ矧阿⒈⒉⒊⒋⒌⒍⒎⒏⒐┅┅┅ê溴篝蝓泗躜箝珙扉篝扉篝侯蹴忮ㄩ箝珙疳蝮瀛铛礅弪吼狎箦铛礅弪翦瘐箬箝珙扉篝┅候徜轼卑疳蝮瀛铛礅弪吼狎箦铛礅弪翦扉篝候徜轼卑┅┅ㄤ彐蝓戾怙镬矧Ⅳ蝓澧㈡犰箦ê灬礅溽翳轭绌扉篝衡镲ㄩ篝蜷铉翳轭Ⅳ蝓澧换义趱蝾脲黠蜾麸犰祜箦磲铘殂麽祀弪殓铒蝈翳屙麒孱篝蜷痧轭秕骘矬呼蝓烘犰箦┅┅ㄤ彐蝓戾狎蜥泔铘孱趔ㄡ钿鲠祯íㄡ钿麒轸弩疳沐＼麒轸弩疳沐鲠祯濠麒轸弩疳沐＼麒轸弩疳沐┅ê灬礅溽翳轭绌换尿镳翳麒轸弩疳沐汜痿躜弩戾è狎蜥扉篝ㄢ豸灬篝ㄢ豸灬篝ㄢ豸灬篝翳轭绌┅┅ㄡ痧孱扉篝ㄣ狎狎蜥扉篝┅换篝蜷翳麒轸弩疳沐犷泔眄轭骘祜镳骘珧秕轭ㄣ徜狎蜥扉篝泔祆邈ㄦ秕螋珧秕皓┅┅ㄤ彐蝓戾狎蜥ㄡ钿＼麒轸弩疳沐狎蜥泔铘孱趔麒轸弩疳沐＼荸ê灬礅溽翳轭绌扉篝横蝌狴翳轵翳轭绌┅ㄤ彐蝓戾鲠祯矧狎蜥溽翦糸礤怙镬铛礅弪篝蜷铉┅ㄤ彐蝓戾孱洵镦轭骘蝽狒轱ㄡ钿í矧＼羽徙＼翎猢＼五黛轭濠ê泔铙翎铘瑚螬ㄤ彐蝓戾脲鲠祯ㄡ钿麒轸弩疳沐铒蝽犰脲麒轸弩疳沐＼麒轸弩疳沐鲠祯孱洵镦轭骘蝽狒轱瞟ê溴篝蝓泗躜鞅脲鞑灞鞒鲠祯鞔ㄤ邈灬蝈ㄩ珙矧鞅鞑灞鞒鞔┅扉篝弘妁鲠祯脲鲠祯濠┅换犭翎忪弩轭爱伯ㄤ彐蝓戾脲珧秕ㄡ钿麒轸弩疳沐＼ǐ脲珧秕瓠汨狎＼麒轸弩疳沐┅ê溴篝蝓泗躜ㄟ卟钺礤叱叽ㄤ邈灬蝈ㄩ珙矧弑卟叱叽┅扉篝鸿遽溴翦钺礤┅┅ㄤ彐蝓戾痱遽礅戾í脲鲠祯濠ㄤ彐蝓戾骈戾珧犴磲ㄡ钿痱遽礅戾换轭翦蜢遽鲩铉íㄡ钿脲珧秕í脲鲠祯濠┅┅ㄤ彐疳蜥礤翦泔眄孱舡筱犷铄颡ㄣ飙痧泸搴泸遽翦筱犷铄换轭轸獒蝈珏腴钿禊泔铘蜷怩翦怡珏咫矬狨蚶轵惝骝邋铒溴铄⑥è坜＼⑤堍è坜苘堍莳苘┆坜苘堍莳堍┅┛（─后轭珈瀛扉铄盹溴铋喉蹯糸扉铄盹溴舂⒂汜铑弪骘泔眄孱趔柔钿戾堍＼篝蜷铉螈ㄤ彐躅篝蜷瓠泔眄孱趔篝蜷铉⒂趄轲翳泔眄孱趔骝镯翳篝蜷铉ㄣ飙痧泸搴蝈珏蝈痨徙瀛犰泔眄孱舡筱犷铄颡篝蜷铉④鼙┅ㄤ彐躅疳蝮瀛篝蜷铉篝蜷铉⒁弭躜铙翳麸盱疳蝮邃篝蝓泗躜骝镯囿趄轭玎矧吼狎箦弪蝻颌疳蝮ф殪瀛珧犴磲篝蜷铉┅换渝磲铘殂犷犰箝麸镬忮祜ㄤ彐躅屮趄徙舡扉箴篝蝓泗躜疳蝮邃篝蝓泗躜濠换砒疱泗轭疳蝮邃篝蝓泗躜麸忮赭扉篝镦扉篝螽涕篝换鏖祆忮翳脲铒忮祜铉轭麸麸瓠戾鲥鲠祯瀹涕篝轶换翦扉篝镦鲠祯弩忮祜铉轭麸麸瓠戾鲥脲螽戾è翎忪磲脲栳箬翎忪换组祆忮泔眇狎轭篝蜷铉骘翳脲呼弩＇羼踽飑┅换疳篌焙珏犰躅桢徜弪邃脲轭麸栳箬翎忪祜镳骘脲鲠祯轭ㄦ轵篝疳蝮邃篝蝓泗躜濠滹箦翩ㄧ弭栳箬箦泔钿脲鲠祯濠翎忪濠痱镢弩蟓鲠祯瀛溽翎翳轵脲鲠祯濠┅换疳篌埠铒蝽犰辁桢徜弪轭麸脲鲠祯弩换换狍疳螋镦翳轶疳篌漉痨殂狒脲狎溴翦泗邃犷犷弪蝻换轶翳蝻黝换换坭碑璨脲骄璞璨脲祜镳骘桢徜弪轭箦泔钿疳蝮邃篝蝓泗躜濠滹ㄡ篌弪ㄥㄣ後桢徜弪鸿遽溴颟戾è脲珧秕瓠桢徜弪ㄣ徜狎桢徜弪┅箦泗轱ㄣ徜桢徜弪┅躅戾篌箦泗轱箦翩ㄧ弭栳箬脲珧秕瓠桢徜弪翎忪濠磲脲栳箬翎忪呼弩＇羼踽飑┅祜镳骘脲鲠祯轭箦泗轱滹ㄡ篌弪ㄥㄦ轵篝脲鲠祯濠弘妁鲠祯濠戾è脲换骑蝽狒翳脲ㄦ矧磲铋岙幄脲珧秕瓠桢徜弪箦泔钿脲鲠祯濠┅眭祠轲戾鲠祯瀛忾钿鲠祯顼趑孱ㄧ弭栳箬脲翎忪濠ㄤ邈灬蝈ㄩ珙矧鲠祯濠换孽痨殂狒鲠祯溴翦泗轱睢ㄡ篌弪铒顼趑孱┅箦翩ㄧ弭栳箬脲翎忪濠换泔祆狃箦鲠祯弩骝镯翳ê豉疱俭趱骀京换轭骘蝽狒轱町痱镢弩蟓鲠祯瀛溽翎翳轵脲鲠祯濠┅┅┅换怛遽搿狒翳轶痫轭艉麇栳鲥骒狒泔眄镱扉箴栳箬翎忪瀣换铒漉痨殂狒脲螽遽汨鲠祯轶扉箴鲠祯泔蝌邈綮换趄犷筱蜷忮骝镯翳麸盱换疳篌钞痨徙翳璞璨脲轭麸铄篝邃栳箬翎忪弩璞骄璨换脲骄鲠祯弩箝钽麇蝈趱蝾翳铄翎忪瀣麇滹瞌铄邃麸换黠蝌徕秕铛腴铉翳镬鲠祯弩ㄥ痨镤瀛栳箬翎忪翎忪濠┅ㄤ彐躅痱镢弩蟓鲠祯瀛溽翎鲠祯濠⑧鲠祯遴磲忮犷镦翳篝犷溽蜾麸盱鲠祯豉疱蠛狎蜥溽翦糸礤怙镬铛礅弪矧篝蜷铉湘翳矬瀣狎蜥狎箴邈獒汜箦吁痧矬轭犷狎蜥轶孱泔躅翦蝈洮痱镢弩蟓鲠祯瀛溽翎蝈沲蝮弩躔镱翳狎蜥燥盱滹弩铒篚痧矧蝈驽蝈钽弩狍镦霭爆犷翳弪骘麇汜趄狯弪箦狎蜥鏖翳秕泫戾镦蝈驽蝈钽弩ㄡ戾犷潋獒后鏖翥è骈蝮鲠祯濠呼弩＇羼ê狎蜥祜镳骘屐轭箦泔钿鲠祯濠泔祆邈痱镢弩蟓鲠祯瀛溽翎屐濠┅ê怙镬ㄡ戾犷潋獒后鏖翥è箦泔钿鲠祯濠ê趄蹂舂ê驷祗铋飑ㄥ蝌矧⒄钺忪麸躅溴蝮翎钿麽翳秕玷麸忮郝舷眭篝忮呼蝓矧烘犰箦箦泔钿鲠祯濠┅┅ê溽翦糸礤换澡溽翦糸礤轶犰蝈徜疳蝮邃箦泔钿鲠祯濠ê篝蜷铉换藻轶犰蝈徜疳蝮邃狍麇祆箦泔钿鲠祯濠ê铛礅弪箦泔钿鲠祯濠ㄥ蝌矧⒄钺忪麸躅溴蝮翎钿峄眭篝忮戾玳痧麸盱豉疱ㄦ轵篝鲠祯濠┅┅ㄤ彐躅脲脲翎忪濠⒛镥嚯妁屮轶轭圄徕戾竣眭祠轲戾鲠祯瀛忾钿鲠祯骘躅洵皓ㄧ弭栳箬脲翎忪濠ㄤ邈灬蝈ㄩ珙矧鲠祯濠骘躅洵皓ㄤ彐躅磲脲铄篝邃栳箬翎忪脲扉篝鲠祯濠戾è脲ㄣ狎脲扉篝┅ㄣ镱换狎麇狒翳孱镦翳脲扉篝è铒ㄣ潋脲扉篝┅箦翩ㄧ弭栳箬脲翎忪濠鲠祯濠ㄩ铒脲脲翎忪濠痱镧箦翩ㄧ弭栳箬脲翎忪濠磲脲栳箬翎忪呼弩＇羼踽飑┅磲脲铄篝邃栳箬ㄧ弭栳箬脲翎忪濠ㄣ潋脲扉篝鲠祯濠┅┅换韵南趱蝾轭麸骒弭骘屮痨镤瀛栳箬翎忪ㄤ彐躅箴祜溴翎忪箴扉趑弪脲鲠祯濠戾è脲扉篝箴扉舡箦聃孱沐后痨轸箦聃孱沐箴扉趑弪脲┅磲脲铄篝邃栳箬翎忪脲扉篝鲠祯濠┅ㄤ彐躅屮痨镤瀛栳箬翎忪翎忪濠戾è铄鳝翎忪磲脲栳箬翎忪呼弩＇羼踽飑┅磲痂狍＇灬礅溽雯箴祜溴铄鳝翎忪＼雯翎忪濠铄鳝翎忪濠ㄤ彐躅疳蝮瀛麸盱篝蜷铉脲篝蜷泗铋飑⑿狎箦韵吞囿趄轭玎蝈趱蝾轭栳箬翎忪泔眇狎徕戾怡叛樟坍囿趄殂羿轶铒篚痧矧翦狒痱弩孱舢戾è痫篝骈铄黛轭邃篝蜷铉ㄣ飙痧泸搴蝈珏蝈痨徙瀛犰④茆苘螵あ篝蜷铉ㄣ镱汜翦钺翦篝蜷铉Ж＼五黛轭濠┅┅ㄥ趄徙舡扉箴篝蝓泗躜疳蝮瀛篝蜷铉篝蜷瓠泔眄孱趔痫篝骈铄黛轭邃篝蜷铉┅┅